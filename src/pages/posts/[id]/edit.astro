---
// src/pages/posts/[id]/edit.astro - COMPLETO FUNCIONAL
import Layout from "../../../layouts/Layout.astro";

const cookies = Astro.cookies;
const accessToken = cookies.get("sb-access-token")?.value;
const userEmailCookie = cookies.get("user-email")?.value || "gardener@example.com";

if (!accessToken) {
  return Astro.redirect("/signin");
}

const displayName = userEmailCookie.split("@")[0] || userEmailCookie || "Gardener";
const postId = Astro.params.id;

// ✅ POST: Update post
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  if (formData.get("action") === "update" && formData.get("postId") === postId) {
    const title = formData.get("title")?.toString().trim();
    const content = formData.get("content")?.toString().trim();
    
    if (title && content) {
      try {
        const supabaseUrl = 'https://fszpmitzgepkbykhmgyu.supabase.co';
        const supabaseKey = 'sb_publishable_PfBgFXn5d5KASgbiYBT4TQ_VtkYCJXv';
        
        const response = await fetch(`${supabaseUrl}/rest/v1/posts?id=eq.${postId}`, {
          method: 'PATCH',
          headers: {
            'apikey': supabaseKey,
            'Authorization': `Bearer ${supabaseKey}`,
            'Content-Type': 'application/json',
            'Prefer': 'resolution=merge-duplicates'
          },
          body: JSON.stringify({
            title,
            content,
            updated_at: new Date().toISOString()
          })
        });
        
        console.log('Update response:', response.status);
        if (response.ok) {
          return Astro.redirect("/posts");
        }
      } catch (error) {
        console.error('Update error:', error);
      }
    }
  }
}

// ✅ GET: Fetch post data
let post = null;
try {
  const supabaseUrl = 'https://fszpmitzgepkbykhmgyu.supabase.co';
  const supabaseKey = 'sb_publishable_PfBgFXn5d5KASgbiYBT4TQ_VtkYCJXv';
  
  const response = await fetch(
    `${supabaseUrl}/rest/v1/posts?select=id,title,content,author_email,author_name&id=eq.${postId}&author_email=eq.${userEmailCookie}`, 
    {
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`
      }
    }
  );
  
  if (response.ok) {
    const data = await response.json();
    post = data[0];
    console.log('Post loaded:', post?.title);
  }
} catch (error) {
  console.error('Fetch post error:', error);
}

if (!post) {
  console.log('No post found, redirecting');
  return Astro.redirect("/posts");
}
---

<Layout title={`Edit Post - ${post.title} - Leaf by Leaf`}>
  <div class="min-h-screen bg-gradient-to-br from-emerald-900 via-green-800 to-teal-900">
    <header class="bg-white/10 backdrop-blur-xl border-b border-white/20">
      <div class="max-w-6xl mx-auto px-6 py-6 flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-black bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">
            Edit Post
          </h1>
          <p class="text-white/70 text-sm">
            Update your post, {displayName}.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <a href="/posts" class="text-emerald-200 hover:text-emerald-100 text-sm font-semibold">← Back to Posts</a>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-10 lg:py-14">
      <section class="bg-white/10 backdrop-blur-xl rounded-3xl p-8 border border-white/20 max-w-2xl mx-auto">
        <h2 class="text-2xl font-bold text-white mb-6">{post.title}</h2>
        
        <form method="post" class="space-y-5">
          <input type="hidden" name="action" value="update" />
          <input type="hidden" name="postId" value={post.id} />
          
          <div>
            <label for="title" class="block text-sm font-semibold text-white/80 mb-2">Title</label>
            <input 
              id="title" 
              name="title" 
              type="text" 
              required 
              value={post.title}
              class="w-full px-4 py-3 rounded-2xl bg-emerald-950/40 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-transparent" 
            />
          </div>
          
          <div>
            <label for="content" class="block text-sm font-semibold text-white/80 mb-2">Content</label>
            <textarea 
              id="content" 
              name="content" 
              required 
              rows="8"
              class="w-full px-4 py-3 rounded-2xl bg-emerald-950/40 border border-white/20 text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:border-transparent resize-vertical"
            >{post.content}</textarea>
          </div>
          
          <div class="flex justify-end gap-3 pt-4 border-t border-white/20">
            <a href="/posts" class="px-6 py-2.5 rounded-2xl border border-white/20 text-white/80 hover:bg-white/10 transition-all duration-200 text-sm font-semibold">Cancel</a>
            <button type="submit" class="px-6 py-2.5 rounded-2xl bg-emerald-500/90 hover:bg-emerald-600 text-white font-semibold text-sm shadow-lg hover:shadow-emerald-500/25 transition-all duration-200">
              Update Post
            </button>
          </div>
        </form>
      </section>
    </main>
  </div>
</Layout>
